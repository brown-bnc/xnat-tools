We welcome issues and pull requests to help improve the xnat-tools model.  We use the following guidelines to ensure standards are met.

## Workflow

When working on xnat-tools, we using a flow a simple flow based on following rules:

1. Use topic/feature branches, no direct commits on master.
2. Perform tests and code reviews before merges into master, not afterwards.
3. Everyone starts from master, and targets master.
4. Commit messages reflect intent.

### Branches

* `master` is the default branch and where releases are made off. This branch should be in clean/working conditions at all times. This branch is protected and can only be merged from Pull Requests for topic branches
* topic branches are created for new features, fixes, or really any changes

<!-- ### Commitizen

All commits should use the angular style.  Commitizen makes this easy.

```
pip install --user commitizen
```

Then use `cz commit` where you would have previously done `git commit`. -->

## Testing

In the future we will add testing as part of CI. For the moment, you'll need to test yourself

`pytest` is the library used for testing.

To run all of the tests:
```
poetry run pytest
```

To run only a file


```
poetry run pytest -x -s -o log_cli=true --log-cli-level=INFO tests/integration/test_export_typer.py
```

`-s` makes sure that `stdout` is printed to terminal
`-o log_cli=true --log-cli-level=INFO` allows the logger output to go to cli
`-x` exists on first failure

You will need to have a local `.env` file where you set some environment variables, e.i `XNAT_PASS`

At the moment the tests can not run bids validation. To do so, you can comment out the line that cleans the output directory and run the validator manually using docker. For instance

```
bids_directory=${PWD}/tests/xnat2bids/ashenhav/study-1222/bids/
docker run -ti --rm -v ${bids_directory}:/data:ro bids/validator /data
```


## Code Style

### black

The code must conform to `black`'s standards and this is automatically checked via github actions.  To automatically fix files, run `poetry run black .` from the root of the `xnat_tools` directory.

### flake8
The code must not have any egregious linting errors. And others should be minimized as reasonable.

Check for egregious errors:
```
poetry run flake8 xnat_tools --count --select=E9,F63,F7,F82 --show-source --statistics
```

Check for all warnings:
```
poetry run flake8 xnat_tools --count --exit-zero --max-complexity=12 --max-line-length=88 --statistics
```

### Typing

Please use [type hints](https://mypy.readthedocs.io/en/stable/) on all signatures where reasonable.  This will make sure the code is more readable, can be statically tested for type soundness, and helps fill in the documentation.

Run the below to check for type errors:
```
mypy xnat_tools
```

## Documentation

All functions and methods should have an up to date [google style docstring](https://sphinxcontrib-napoleon.readthedocs.io/en/latest/example_google.html).  These docstrings are used to build xnat-tools's documentation website.  Additional prose can be added to the website by editing the appropriate markdown file in the `docs/` directory.

To develop/see the docs locally, run:
```
mkdocs serve
```
then navigate to http://localhost:8000 to see your docs.  They will automoatically reload as you make changes to files.

### Documentation for console scripts

The markdown files for console scripts are generated by the `typer-cli`. Here is an example of how to call it manually from your Poetry shell i.e `poetry shell`

```
PYTHONPATH=<path-to-xnat-tools> typer ./dicom_export.py utils docs --name xnat-dicom-export --output ../docs/dicom_export.md
```